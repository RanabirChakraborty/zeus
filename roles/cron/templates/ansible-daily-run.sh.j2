#!/bin/bash

readonly LOGFILE=$(mktemp)
trap "rm -f ${LOGFILE}" EXIT

ansible-playbook -D /etc/ansible/zeus.yml 2>&1 > "${LOGFILE}"
readonly SUBJECT=$(tail -2 "${LOGFILE}" | sed '/^$/d' | head -1)
cat "${LOGFILE}" | \
  mailx -r "{{ mailer.to }}" -s "{{ item.name }}:${SUBJECT}" -S smtp="{{ mailer.smtp.host }}:{{mailer.smtp.port }}" "{{ mailer.replyTo }}"
